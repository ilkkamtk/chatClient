function checkImage(a){return a.onerror="",a.src="http://placekitten.com/65/64",!0}var uID=0,messages=new Array;$(function(){function a(){$.getJSON("http://users.metropolia.fi/~ilkkamtk/chatApi/threads",function(c){b(c,$("#messages"));setTimeout(a,5e3)})}function b(a,c){$.each(a,function(a,d){var e=null;if(-1===messages.indexOf(d.mID)){console.log(c),messages.push(d.mID),e="UL"===c.prop("tagName")?$('<li class="media" data-id="'+d.mID+'"></li>').prependTo(c):$('<div class="media" data-id="'+d.mID+'"></div>').appendTo(c);var f=($('<div class="media-left"><img class="media-object img-thumbnail" src="'+d.thumbnail+'" alt="avatar" onerror="checkImage(this)"></div>').appendTo(e),$('<div class="media-body"></div>').appendTo(e)),g=($('<h4 class="media-heading">'+d.name+"</h3>").appendTo(f),moment.unix()-d.time),h="";h=60>g?moment.unix(d.time,"ss").fromNow():3600>g?moment.unix(d.time,"mm").fromNow():86400>g?moment.unix(d.time,"HH").fromNow():moment.unix(d.time,"DD").fromNow();{$('<span class="text-muted">'+h+"</span>").appendTo(f)}$("<br>").appendTo(f);var i=($('<span class="viesti">'+d.message+"</span>").appendTo(f),$('<div class="btn-group pull-right" role="group" aria-label="toiminnot"></div>').appendTo(f)),j=$('<button class="btn btn-default btn-xs" data-toggle="modal" data-target="#replyModal" data-mID="'+d.mID+'">Vastaa</button>').appendTo(i);if(j.click(function(){$('input[name="parent"]').attr("value",$(this).attr("data-mID"))}),uID==d.user_id){var k=$('<button class="btn btn-info btn-xs" data-toggle="modal" data-target="#modifyModal" data-mID="'+d.mID+'">Muokkaa</button>').appendTo(i);k.click(function(){$("#modifyModal textarea").text($(this).parent().parent().children(".viesti").text()),$('input[name="mID"]').attr("value",$(this).attr("data-mID"))});var l=$('<button class="btn btn-danger btn-xs" data-mID="'+d.mID+'">Poista</button>').appendTo(i);l.click(function(){$.ajax({url:"http://users.metropolia.fi/~ilkkamtk/chatApi/messages/"+l.attr("data-mID"),type:"DELETE",success:function(a){"ERROR"===a.status&&alert("Ei voi poistaa."),$('[data-id="'+d.mID+'"]').remove()},dataType:"json"})})}{$("<hr>").appendTo(f)}}d.children&&b(d.children,$('[data-id="'+d.children[0].parent+'"] .media-body:first'))})}function c(a){$("#profiili").html($('<h2>Profiili</h2><div class="panel panel-default"><div class="panel-body"><div class="media"><div class="media-body"><h4>'+a.name+'</h4><img class="media-object img-thumbnail center-block" src="'+a.profileImage+'.jpg" alt="avatar" onerror="checkImage(this)"></div></div><div class="btn-group btn-group-justified" role="group" aria-label="toiminnot"><div class="btn-group" role="group"><button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#imageModal">Vaihda kuva</button></div><div class="btn-group" role="group"><button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#messageModal">Uusi viesti</button></div><div class="btn-group" role="group"><button type="button" class="btn btn-danger btn-sm" data-uid="'+a.uID+'">Poista minut</button></div></div></div></div>')),$("#profiili .btn-danger").click(function(){$(this).attr("data-uid");$.ajax({method:"DELETE",url:"http://users.metropolia.fi/~ilkkamtk/chatApi/users/"+uID,success:function(a){"OK"===a.status&&location.reload()},dataType:"json"})})}$("#messageModal form").submit(function(b){b.preventDefault();var c=$(this).serialize();$.post("http://users.metropolia.fi/~ilkkamtk/chatApi/messages",c,function(){$("#messageModal").modal("hide"),a()},"json")}),$("#replyModal form").submit(function(b){b.preventDefault();var c=$(this).serialize();$.post("http://users.metropolia.fi/~ilkkamtk/chatApi/threads",c,function(){$("#replyModal").modal("hide"),a()},"json")}),$("#modifyModal form").submit(function(b){b.preventDefault();var c=$(this).serialize();$.ajax({method:"PUT",url:"http://users.metropolia.fi/~ilkkamtk/chatApi/messages",data:c,success:function(){$("#modifyModal").modal("hide"),a()},dataType:"json"})}),$("#loginForm").submit(function(b){b.preventDefault();var d=$(this).serialize();$.post("http://users.metropolia.fi/~ilkkamtk/chatApi/login",d,function(b){return"LOGIN_ERROR"===b.status?($("#loginForm").append('<p class="alert alert-danger">Käyttäjänimeä ei löydy.</p>'),!1):(uID=b.uID,$('input[name="uID"]').attr("value",b.uID),$('input[name="name"]').attr("value",b.name),c(b),void a())},"json")}),$("#signInForm").submit(function(b){b.preventDefault();var d=$(this).serialize();$.post("http://users.metropolia.fi/~ilkkamtk/chatApi/users",d,function(b){return"USER_EXISTS"===b.status?($("#signInForm").append('<p class="alert alert-danger">Käyttäjä on jo olemassa.</p>'),!1):(uID=b.uID,$('input[name="uID"]').attr("value",b.uID),$('input[name="name"]').attr("value",b.name),c(b),void a())},"json")}),$("#imageForm").submit(function(b){var d={type:"POST",dataType:"json",url:"http://users.metropolia.fi/~ilkkamtk/chatApi/images",success:function(b){return"ERROR:NOT IMAGE"===b.status?($("#signInForm").append('<p class="alert alert-danger">Virhe.</p>'),!1):($("#imageModal").modal("hide"),c(b),void a())}};b.preventDefault(),$(this).ajaxSubmit(d)})});